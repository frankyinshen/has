<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evan's Grammar Adventure (Full Version)</title>
    <style>
        :root {
            --primary: #4A90E2;
            --success: #66BB6A;
            --warning: #FFA726;
            --danger: #EF5350;
            --bg: #F0F4F8;
            --card: #FFFFFF;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        .container {
            background-color: var(--card);
            width: 90%;
            max-width: 600px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            border: 5px solid var(--primary);
        }

        h1 { color: var(--primary); margin-bottom: 10px; font-size: 1.8rem; }
        h2 { color: #555; font-size: 1.2rem; }
        
        .rule-box {
            background-color: #E3F2FD;
            border: 2px dashed var(--primary);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .highlight { color: #D32F2F; font-weight: bold; background: #FFEBEE; padding: 2px 5px; border-radius: 4px; }
        .magic { color: #7B1FA2; font-weight: bold; }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            margin: 10px;
            width: 80%;
            max-width: 300px;
        }

        .btn:hover { transform: scale(1.05); background-color: #357ABD; }
        .btn:active { transform: scale(0.95); }

        .options-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .option-btn {
            background-color: white;
            border: 3px solid #DDD;
            color: #555;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover { border-color: var(--primary); background-color: #F5F9FF; }

        .feedback-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .feedback-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            animation: popIn 0.3s;
            border: 4px solid;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #EEE;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.5s;
        }

        .hidden { display: none; }
        
        .mascot { font-size: 3rem; margin-bottom: 10px; display: block; }
        
        .score-badge {
            background: #FFF3E0; color: #E65100;
            padding: 5px 15px; border-radius: 20px;
            font-weight: bold; font-size: 0.9rem;
            display: inline-block; margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container" id="app">
    <!-- æ¬¢è¿é¡µé¢ -->
    <div id="welcome-screen">
        <span class="mascot">ğŸ¦</span>
        <h1>Hi, Evan! Ready for the Challenge?</h1>
        <p>é¢˜åº“å·²å‡çº§åˆ° 100+ é“é¢˜ç›®ï¼</p>
        <p>æ¯æ¬¡é—¯å…³ï¼Œæˆ‘ä¼šéšæœºæŒ‘å‡ºå‡ é“é¢˜è€ƒè€ƒä½ ã€‚</p>
        <button class="btn" onclick="startLevel(1)">Start Level 1</button>
    </div>

    <!-- è§„åˆ™è®²è§£é¡µé¢ -->
    <div id="rule-screen" class="hidden">
        <span class="mascot">ğŸ“–</span>
        <h1 id="rule-title">Level Rules</h1>
        <div class="rule-box" id="rule-content"></div>
        <button class="btn" onclick="startQuiz()">I Understand! Let's Go!</button>
    </div>

    <!-- ç­”é¢˜é¡µé¢ -->
    <div id="quiz-screen" class="hidden">
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
        <h2 id="level-indicator">Level 1</h2>
        <div style="font-size: 1.5rem; margin: 30px 0;" id="question-text">
            Question goes here...
        </div>
        <div class="options-grid" id="options-container">
            <!-- é€‰é¡¹æŒ‰é’®ä¼šç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>

    <!-- ç»“æœé¡µé¢ -->
    <div id="result-screen" class="hidden">
        <span class="mascot" id="result-emoji">ğŸ†</span>
        <h1 id="result-title">Level Complete!</h1>
        <p id="result-message">Good job, Evan!</p>
        <button class="btn" id="next-level-btn" onclick="nextStage()">Next Level â¡ï¸</button>
        <button class="btn" id="retry-btn" onclick="retryLevel()">Try Again (New Questions) ğŸ”„</button>
    </div>
</div>

<!-- åé¦ˆå¼¹çª— -->
<div class="feedback-modal" id="feedback-modal">
    <div class="feedback-content" id="feedback-box">
        <h2 id="fb-title"></h2>
        <p id="fb-text" style="font-size: 1.1rem; margin: 20px 0;"></p>
        <button class="btn" onclick="closeFeedback()">OK</button>
    </div>
</div>

<script>
    // --- æµ·é‡é¢˜åº“æ•°æ® (100+ Questions) ---
    const allQuestionsData = {
        level1: [
            // Have (I, You, We, They, Plural)
            { q: "I ______ a red bicycle.", options: ["have", "has", "had"], a: "have" },
            { q: "You ______ a beautiful smile.", options: ["have", "has", "had"], a: "have" },
            { q: "We ______ many toys.", options: ["have", "has", "had"], a: "have" },
            { q: "They ______ a big house.", options: ["have", "has", "had"], a: "have" },
            { q: "The cats ______ long tails.", options: ["have", "has", "had"], a: "have" },
            { q: "Tom and Jerry ______ a plan.", options: ["have", "has", "had"], a: "have" },
            { q: "My friends ______ a secret.", options: ["have", "has", "had"], a: "have" },
            { q: "I ______ two brothers.", options: ["have", "has", "had"], a: "have" },
            { q: "Do you ______ a minute?", options: ["have", "has", "had"], a: "have" },
            { q: "Cars ______ four wheels.", options: ["have", "has", "had"], a: "have" },
            { q: "You and I ______ homework to do.", options: ["have", "has", "had"], a: "have" },
            { q: "Birds ______ wings.", options: ["have", "has", "had"], a: "have" },
            { q: "We ______ a meeting today.", options: ["have", "has", "had"], a: "have" },
            { q: "They ______ new shoes.", options: ["have", "has", "had"], a: "have" },
            { q: "I ______ a headache.", options: ["have", "has", "had"], a: "have" },

            // Has (He, She, It, Singular)
            { q: "She ______ a cute puppy.", options: ["have", "has", "had"], a: "has" },
            { q: "He ______ a blue pen.", options: ["have", "has", "had"], a: "has" },
            { q: "It ______ a long neck.", options: ["have", "has", "had"], a: "has" },
            { q: "Tom ______ a fast car.", options: ["have", "has", "had"], a: "has" },
            { q: "My mom ______ nice hair.", options: ["have", "has", "had"], a: "has" },
            { q: "The dog ______ a bone.", options: ["have", "has", "had"], a: "has" },
            { q: "Evan ______ a cool iPad.", options: ["have", "has", "had"], a: "has" },
            { q: "The house ______ big windows.", options: ["have", "has", "had"], a: "has" },
            { q: "Everyone ______ a name.", options: ["have", "has", "had"], a: "has" },
            { q: "My sister ______ a pink dress.", options: ["have", "has", "had"], a: "has" },
            { q: "The elephant ______ a long nose.", options: ["have", "has", "had"], a: "has" },
            { q: "My dad ______ a job.", options: ["have", "has", "had"], a: "has" },
            { q: "The sun ______ a bright light.", options: ["have", "has", "had"], a: "has" },
            { q: "This book ______ many pages.", options: ["have", "has", "had"], a: "has" },
            { q: "Nobody ______ the answer.", options: ["have", "has", "had"], a: "has" },

            // Had (Past Tense - Yesterday, Last...)
            { q: "Yesterday, I ______ an apple.", options: ["have", "has", "had"], a: "had" },
            { q: "Last year, she ______ short hair.", options: ["have", "has", "had"], a: "had" },
            { q: "We ______ a party last night.", options: ["have", "has", "had"], a: "had" },
            { q: "They ______ fun at the park yesterday.", options: ["have", "has", "had"], a: "had" },
            { q: "My dog ______ a bath last week.", options: ["have", "has", "had"], a: "had" },
            { q: "I ______ a bad dream last night.", options: ["have", "has", "had"], a: "had" },
            { q: "He ______ a cold yesterday.", options: ["have", "has", "had"], a: "had" },
            { q: "We ______ pizza for dinner yesterday.", options: ["have", "has", "had"], a: "had" },
            { q: "Long ago, dinosaurs ______ big teeth.", options: ["have", "has", "had"], a: "had" },
            { q: "She ______ a test last Friday.", options: ["have", "has", "had"], a: "had" },
            { q: "You ______ a chance yesterday.", options: ["have", "has", "had"], a: "had" },
            { q: "The cat ______ a mouse in its mouth just now.", options: ["have", "has", "had"], a: "had" },
            { q: "My grandpa ______ a farm.", options: ["have", "has", "had"], a: "had" },
            { q: "Last month, we ______ a holiday.", options: ["have", "has", "had"], a: "had" },
            { q: "Yesterday morning, I ______ milk.", options: ["have", "has", "had"], a: "had" }
        ],
        level2: [
            // Negatives (Don't/Doesn't/Didn't + HAVE)
            { q: "He doesn't ______ a car.", options: ["have", "has", "had"], a: "have" },
            { q: "She doesn't ______ any money.", options: ["have", "has", "had"], a: "have" },
            { q: "I don't ______ a clue.", options: ["have", "has", "had"], a: "have" },
            { q: "We didn't ______ time yesterday.", options: ["have", "has", "had"], a: "have" },
            { q: "They don't ______ a dog.", options: ["have", "has", "had"], a: "have" },
            { q: "The cat doesn't ______ wings.", options: ["have", "has", "had"], a: "have" },
            { q: "My mom didn't ______ lunch.", options: ["have", "has", "had"], a: "have" },
            { q: "Tom doesn't ______ a bike.", options: ["have", "has", "had"], a: "have" },
            { q: "You didn't ______ to do that.", options: ["have", "has", "had"], a: "have" },
            { q: "It doesn't ______ make sense.", options: ["have", "has", "had"], a: "have" },
            { q: "Evan doesn't ______ school today.", options: ["have", "has", "had"], a: "have" },
            { q: "My phone doesn't ______ battery.", options: ["have", "has", "had"], a: "have" },
            { q: "We didn't ______ fun.", options: ["have", "has", "had"], a: "have" },
            { q: "He didn't ______ his homework.", options: ["have", "has", "had"], a: "have" },
            { q: "She doesn't ______ glasses.", options: ["have", "has", "had"], a: "have" },

            // Questions (Do/Does/Did + HAVE)
            { q: "Does she ______ a brother?", options: ["have", "has", "had"], a: "have" },
            { q: "Do you ______ a pen?", options: ["have", "has", "had"], a: "have" },
            { q: "Did they ______ a good trip?", options: ["have", "has", "had"], a: "have" },
            { q: "Does he ______ the key?", options: ["have", "has", "had"], a: "have" },
            { q: "Did Evan ______ breakfast?", options: ["have", "has", "had"], a: "have" },
            { q: "Does the dog ______ food?", options: ["have", "has", "had"], a: "have" },
            { q: "Do we ______ homework?", options: ["have", "has", "had"], a: "have" },
            { q: "Did you ______ a nightmare?", options: ["have", "has", "had"], a: "have" },
            { q: "Does your dad ______ a car?", options: ["have", "has", "had"], a: "have" },
            { q: "Did she ______ a haircut?", options: ["have", "has", "had"], a: "have" },
            { q: "Do cats ______ nine lives?", options: ["have", "has", "had"], a: "have" },
            { q: "Does it ______ to be this hard?", options: ["have", "has", "had"], a: "have" },
            { q: "Did Tom ______ a party?", options: ["have", "has", "had"], a: "have" },
            { q: "Do they ______ a swimming pool?", options: ["have", "has", "had"], a: "have" },
            { q: "Does Mary ______ a sister?", options: ["have", "has", "had"], a: "have" },
            
            // Tricky mixes
            { q: "Why does he ______ so many toys?", options: ["have", "has", "had"], a: "have" },
            { q: "When did you ______ lunch?", options: ["have", "has", "had"], a: "have" },
            { q: "Where does she ______ her lessons?", options: ["have", "has", "had"], a: "have" },
            { q: "Does Evan ______ a question?", options: ["have", "has", "had"], a: "have" }
        ],
        level3: [
            // Having (Continuous - Now/At the moment)
            { q: "Look! He is ______ lunch.", options: ["have", "has", "having"], a: "having" },
            { q: "We are ______ a great time now.", options: ["have", "has", "having"], a: "having" },
            { q: "They are ______ a meeting right now.", options: ["have", "has", "having"], a: "having" },
            { q: "I am ______ difficulty with this.", options: ["have", "has", "having"], a: "having" },
            { q: "She is ______ breakfast.", options: ["have", "has", "having"], a: "having" },
            { q: "Are you ______ fun?", options: ["have", "has", "having"], a: "having" },
            { q: "The dog is ______ a bath now.", options: ["have", "has", "having"], a: "having" },
            { q: "Mom is ______ a cup of tea.", options: ["have", "has", "having"], a: "having" },
            { q: "We are ______ a party!", options: ["have", "has", "having"], a: "having" },
            { q: "He is ______ a shower.", options: ["have", "has", "having"], a: "having" },

            // Ultimate Mix (Review of all rules)
            { q: "Last year, I ______ a small bike.", options: ["have", "has", "had"], a: "had" },
            { q: "He usually ______ toast for breakfast.", options: ["have", "has", "having"], a: "has" },
            { q: "Does she ______ a cold?", options: ["have", "has", "had"], a: "have" },
            { q: "Look! They are ______ dinner.", options: ["have", "has", "having"], a: "having" },
            { q: "I didn't ______ my wallet.", options: ["have", "has", "had"], a: "have" },
            { q: "Yesterday, we ______ no school.", options: ["have", "has", "had"], a: "had" },
            { q: "My cat ______ green eyes.", options: ["have", "has", "having"], a: "has" },
            { q: "Do you ______ a map?", options: ["have", "has", "had"], a: "have" },
            { q: "She is ______ a baby.", options: ["have", "has", "having"], a: "having" },
            { q: "Tom doesn't ______ any siblings.", options: ["have", "has", "had"], a: "have" },
            { q: "Did you ______ enough sleep?", options: ["have", "has", "had"], a: "have" },
            { q: "Right now, I am ______ a break.", options: ["have", "has", "having"], a: "having" },
            { q: "They ______ a new teacher last year.", options: ["have", "has", "had"], a: "had" },
            { q: "Does the sun ______ a face?", options: ["have", "has", "had"], a: "have" },
            { q: "I ______ many books at home.", options: ["have", "has", "having"], a: "have" }
        ]
    };

    const levelRules = {
        level1: {
            title: "Level 1: ç°åœ¨çš„æˆ‘å’Œä»–ï¼Œè¿˜æœ‰è¿‡å»",
            rule: `
                <strong>1. ç°åœ¨çš„ "Have" vs "Has"</strong><br>
                ğŸ‘‰ <strong>Have:</strong> æˆ‘(I)ã€ä½ (You)ã€å¤§å®¶(We/They/å¤æ•°)ã€‚<br>
                ğŸ‘‰ <strong>Has:</strong> ä»–(He)ã€å¥¹(She)ã€å®ƒ(It)ã€å•ä¸ªåå­—(Tom)ã€‚<br>
                <em>å£è¯€ï¼šHas æœ‰ä¸ª "s"ï¼Œé€ç»™å­¤å•çš„ "Single" (å•ä¸ªäºº)ã€‚</em><br><br>
                <strong>2. è¿‡å»çš„ "Had"</strong><br>
                ğŸ‘‰ åªè¦æ˜¯è¿‡å»çš„äº‹æƒ… (Yesterday, Last year)ï¼Œå¤§å®¶éƒ½ç”¨ <strong>Had</strong>ï¼
            `
        },
        level2: {
            title: "Level 2: é­”æ³•ç…§å¦–é•œ (Do/Does/Did)",
            rule: `
                <strong>âš ï¸ æœ€å®¹æ˜“é”™çš„åœ°æ–¹ï¼</strong><br><br>
                å½“å¥å­é‡Œå‡ºç°äº†å°å¸®æ‰‹ï¼š<br>
                <span class="highlight">Do / Does / Did</span><br>
                <span class="highlight">Don't / Doesn't / Didn't</span><br><br>
                åé¢çš„åŠ¨è¯å¿…é¡»è¢«æ‰“å›åŸå½¢ ğŸ‘‰ <strong>HAVE</strong>ã€‚<br>
                <em>ä¸ç®¡å‰é¢æ˜¯ He è¿˜æ˜¯ Sheï¼Œä¹Ÿä¸ç®¡æ˜¯ä¸æ˜¯æ˜¨å¤©ï¼</em>
            `
        },
        level3: {
            title: "Level 3: æ­£åœ¨è¿›è¡Œ & ç»ˆæå¤§æŒ‘æˆ˜",
            rule: `
                <strong>1. æ­£åœ¨åš (Having)</strong><br>
                å¦‚æœæ˜¯ "æ­£åœ¨åƒ" æˆ– "æ­£åœ¨ç©" (Now/Right now)ï¼Œç”¨ <span class="magic">Having</span>ã€‚<br>
                <em>æ³¨æ„ï¼šHave å»æ‰ e å†åŠ  ingï¼</em><br><br>
                <strong>2. æ··åˆå¤§æŒ‘æˆ˜</strong><br>
                è¿™ä¸€å…³åŒ…å«äº†ä¹‹å‰å­¦è¿‡çš„æ‰€æœ‰é™·é˜±å“¦ï¼å°å¿ƒ Do/Does/Didï¼
            `
        }
    };

    // æ¸¸æˆçŠ¶æ€
    let currentLevel = 1;
    let questionQueue = [];
    let currentQIndex = 0;
    
    // æ¯æ¬¡æ¯å…³æŠ½å–çš„é¢˜ç›®æ•°é‡
    const QUESTIONS_PER_ROUND = 15;

    // è·å–DOMå…ƒç´ 
    const screens = {
        welcome: document.getElementById('welcome-screen'),
        rule: document.getElementById('rule-screen'),
        quiz: document.getElementById('quiz-screen'),
        result: document.getElementById('result-screen')
    };

    function showScreen(screenId) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[screenId].classList.remove('hidden');
    }

    // æ´—ç‰Œç®—æ³•ï¼šæ‰“ä¹±é¢˜ç›®é¡ºåº
    function shuffleArray(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function startLevel(level) {
        currentLevel = level;
        const ruleData = levelRules['level' + level];
        const allQuestions = allQuestionsData['level' + level];
        
        document.getElementById('rule-title').innerText = ruleData.title;
        document.getElementById('rule-content').innerHTML = ruleData.rule;
        
        // æ ¸å¿ƒé€»è¾‘ï¼šå…ˆæ·±æ‹·è´ï¼Œå†æ´—ç‰Œï¼Œæœ€ååˆ‡ç‰‡å–å‡ºå‰ N é“é¢˜
        // è¿™æ ·æ¯æ¬¡ç©çš„é¢˜ç›®éƒ½ä¸ä¸€æ ·ï¼Œä½†åˆä¸ä¼šä¸€æ¬¡åšå¤ªå¤š
        let fullList = JSON.parse(JSON.stringify(allQuestions));
        let shuffledList = shuffleArray(fullList);
        questionQueue = shuffledList.slice(0, QUESTIONS_PER_ROUND);
        
        currentQIndex = 0;
        showScreen('rule');
    }

    function startQuiz() {
        showScreen('quiz');
        loadQuestion();
    }

    function loadQuestion() {
        const q = questionQueue[currentQIndex];
        // è¿›åº¦æ˜¾ç¤ºï¼šå‰©ä½™é¢˜ç›®æ•°
        const remaining = questionQueue.length - currentQIndex;
        document.getElementById('level-indicator').innerText = `Level ${currentLevel} - Question ${currentQIndex + 1} / ${questionQueue.length}`;
        document.getElementById('question-text').innerText = q.q;
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt);
            container.appendChild(btn);
        });

        // æ›´æ–°è¿›åº¦æ¡
        const percent = (currentQIndex / questionQueue.length) * 100;
        document.querySelector('.progress-fill').style.width = percent + '%';
    }

    function checkAnswer(selected) {
        const q = questionQueue[currentQIndex];
        const feedbackModal = document.getElementById('feedback-modal');
        const fbBox = document.getElementById('feedback-box');
        const fbTitle = document.getElementById('fb-title');
        const fbText = document.getElementById('fb-text');

        feedbackModal.style.display = 'flex';

        if (selected === q.a) {
            // å›ç­”æ­£ç¡®
            fbBox.style.borderColor = 'var(--success)';
            fbTitle.innerText = "Awesome, Evan! ğŸŒŸ";
            fbTitle.style.color = 'var(--success)';
            fbText.innerText = "Correct! ä½ ç­”å¯¹äº†ï¼";
        } else {
            // å›ç­”é”™è¯¯
            fbBox.style.borderColor = 'var(--danger)';
            fbTitle.innerText = "Oops! Evan, wait...";
            fbTitle.style.color = 'var(--danger)';
            
            let explanation = "";
            // é€šç”¨è§£é‡Šé€»è¾‘
            if (q.q.includes("Yesterday") || q.q.includes("Last") || q.q.includes("ago")) {
                 explanation = "çœ‹åˆ° Yesterday/Last (è¿‡å»æ—¶é—´) äº†å—ï¼Ÿè¿‡å»çš„äº‹æƒ…è¦ç”¨ Hadã€‚";
            } else if (q.q.includes("Do") || q.q.includes("Does") || q.q.includes("Did") || q.q.includes("n't")) {
                 explanation = "è­¦æŠ¥ï¼çœ‹åˆ° Do/Does/Did/Don't/Doesn't/Didn't è¿™äº›ç…§å¦–é•œäº†å—ï¼Ÿå¿…é¡»å˜å›åŸå½¢ Haveï¼";
            } else if (q.q.includes("Now") || q.q.includes("now") || q.q.includes("ing")) {
                 explanation = "ç°åœ¨æ­£åœ¨åšçš„äº‹æƒ… (Now)ï¼Œè¦ç”¨ Havingã€‚";
            } else {
                 if (q.a === 'have') explanation = "I / You / We / They / å¤æ•°ï¼Œè¦ç”¨ Haveã€‚";
                 if (q.a === 'has') explanation = "He / She / It / å•ä¸ªäººåï¼Œè¦ç”¨ Has (ä¸‰å•)ã€‚";
                 if (q.a === 'had') explanation = "è¿‡å»å‘ç”Ÿçš„äº‹æƒ…ç”¨ Hadã€‚";
                 if (q.a === 'having') explanation = "æ­£åœ¨åšç”¨ Havingã€‚";
            }
            
            fbText.innerHTML = `æ­£ç¡®ç­”æ¡ˆæ˜¯ <strong>${q.a}</strong>ã€‚<br><br>${explanation}<br><br>ğŸ‘‰ <strong>è¿™é“é¢˜æˆ‘ä»¬æŠŠå®ƒæ”¾åˆ°æœ€åï¼Œå†è€ƒä¸€æ¬¡å“¦ï¼</strong>`;
            
            // é”™é¢˜é€»è¾‘ï¼šæŠŠè¿™é“é¢˜å¤åˆ¶ä¸€ä»½åŠ åˆ°é˜Ÿåˆ—æœ«å°¾
            if (!q.isRetry) {
                let retryQ = JSON.parse(JSON.stringify(q));
                retryQ.isRetry = true; 
                questionQueue.push(retryQ);
            }
        }
    }

    function closeFeedback() {
        document.getElementById('feedback-modal').style.display = 'none';
        currentQIndex++;
        
        if (currentQIndex < questionQueue.length) {
            loadQuestion();
        } else {
            finishLevel();
        }
    }

    function finishLevel() {
        showScreen('result');
        const totalQ = QUESTIONS_PER_ROUND;
        const totalAttempts = questionQueue.length;
        const isPerfect = totalAttempts === totalQ;

        if (isPerfect) {
            document.getElementById('result-emoji').innerText = "ğŸ†";
            document.getElementById('result-title').innerText = "Perfect! æ»¡åˆ†é€šå…³ï¼";
            document.getElementById('result-message').innerText = `Evan, ä½ åœ¨ Level ${currentLevel} è¡¨ç°å®Œç¾ï¼`;
            document.getElementById('next-level-btn').classList.remove('hidden');
            document.getElementById('retry-btn').classList.add('hidden');
            
            if (currentLevel === 3) {
                document.getElementById('next-level-btn').innerText = "å…¨éƒ¨é€šå…³ï¼ğŸ‰";
                document.getElementById('next-level-btn').onclick = () => alert("æ­å–œEvanå®Œæˆæ‰€æœ‰è®­ç»ƒï¼ä½ æ˜¯è¯­æ³•å¤§å¸ˆäº†ï¼");
            }
        } else {
            document.getElementById('result-emoji').innerText = "ğŸ‘";
            document.getElementById('result-title').innerText = "Level Complete!";
            document.getElementById('result-message').innerText = `Evan, ä½ å®Œæˆäº† Level ${currentLevel}ï¼è™½ç„¶ä¸­é—´æœ‰å‡ ä¸ªå°é”™è¯¯ï¼Œä½†ä½ éƒ½è®¢æ­£äº†ï¼Œå¾ˆæ£’ï¼`;
            
            document.getElementById('next-level-btn').classList.remove('hidden');
            document.getElementById('retry-btn').classList.remove('hidden');
            
            if (currentLevel === 3) {
                document.getElementById('next-level-btn').innerText = "å…¨éƒ¨é€šå…³ï¼ğŸ‰";
                document.getElementById('next-level-btn').onclick = () => alert("æ­å–œEvanå®Œæˆæ‰€æœ‰è®­ç»ƒï¼");
            }
        }
    }

    function nextStage() {
        if (currentLevel < 3) {
            startLevel(currentLevel + 1);
        } else {
            alert("ä½ å·²ç»é€šå…³äº†ï¼å»åƒä¸ªå†°æ·‡æ·‹åº†ç¥ä¸€ä¸‹å§ï¼ğŸ¦");
        }
    }

    function retryLevel() {
        startLevel(currentLevel);
    }

</script>

</body>
</html>
